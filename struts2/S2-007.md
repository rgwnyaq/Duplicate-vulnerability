### 漏洞复现
当存在变量限制时，当用户输入的值超出限制时，就会将其视作ognl表达式进行执行。例如这个环境中限制age为int型并限制长度：   
    
        <validators>
        <field name="age">
            <field-validator type="int">
                <param name="min">1</param>
                <param name="max">150</param>
                <message>"错误"</message>
            </field-validator>
        </field>
    </validators>
那么我们输入age为特殊命令时，就会产生漏洞了。例如获取tomcat执行路径，输入
```
%{"tomcatBinDir{"+@java.lang.System@getProperty("user.dir")+"}"}
```
![avatar](/pictures/07rec.png)      
在age的输入框就爆出了Tomcat的执行路径


### 漏洞分析
#### 影响版本
Struts 2.0.0 - Struts 2.2.3
#### 漏洞成因
当存在变量限制时，Struts存在变量转换，此时会出错，将变量视作OGNL表达式进行解析执行。造成远程代码执行漏洞。


### 代码跟进
#### IDEA搭建
之前已经大致了解了Struts2框架的在IDEA的搭建，感觉后面在一个一个自己去弄太麻烦了。正好之前了解了vulhub，在github上找到了vulhub的代码上面包含了S2的一些比较重要的洞，干脆就下下来。主要利用其中的war，利用GUI反编译war获取里面的web内容。再将这些内容放入之前搭建好的IDEA项目的webcontent文件夹中即可。     
o(╥﹏╥)o 最好是直接将demo中需要更改的例如struts.xml、index.jsp中的内容对应改一下。注意package那些不要漏改了。
#### 分析流程
当S2框架处理变量转换时，会通过ConversionErrorInterceptor.class处理，并返回错误信息。
直接来到这个类中查看他做了哪些处理：    
![avatar](/pictures/con_error01.png)    
30行中可以看到，代码中获取了错误的键值信息，并存入了Map中；     
38行中将错误的值单独提出给到了value；   
40行中确实存在错误，将提示错误的信息存入了message中，内容为“Invalid field value for field “age””；    
![avatar](/pictures/con_error02.png)    
48-51行中将刚刚的error的map给到了fakie这个hashmap，并将hashmap存入了invocation中；    
68行中处理完converterror后，接着执行后面所需要进行的步骤。  
似乎处理流程并没有什么问题，然而现在传递出去的invocation中仍然存在“age”为恶意命令。我们也知道OGNL表达式回去栈中查看根值：     
![avatar](/pictures/stack.png)  
这里就是刚刚的hashmap中获取的值，在后面Ognl表达式时，就会选取后面的age为错误表达式的值。  
去TextParseUtil.class里看看ognl处理的age，证实一下刚刚所说：    
![avatar](/pictures/age.png)    
这里看到确实是解析的是恶意命令而非空。

### 参考链接
https://github.com/vulhub/vulhub/tree/master    
https://blog.csdn.net/Fly_hps/article/details/85001622
