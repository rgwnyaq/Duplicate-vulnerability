### 前置知识
#### Struts2标签
要使用Struts2的标签，只需要在JSP页面添加如下一行定义即可：  
<%@ taglib prefix="s" uri="/struts-tags"%>      
Struts2的标签共分为五大类：     
一. 逻辑控制标签    
二. 数据输出标签    
三. HTML表单标签    
四. HTML非表单标签  
五. AJAX标签    
S2框架的开发各种前端页面基本基于这些标签，毕竟我也不做开发。大致了解一下就可以了。如果下次在遇到了就去看看参考链接的第一个有各种标签的详细说明。    

此外s2的标签库都是集成与ComponentTagSupport类，需要调试时直接去这个类里看就行。
### 漏洞复现
#### S2-002
以<s:url>为例，随意构造一个含有<s:url>的jsp页面：   

    <%@taglib prefix="s" uri="/struts-tags" %>
    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <body>
    <a href="<s:url action="login" includeParams="all" ></s:url>">Struts2</a>
    </body>
    </html>
在action中为了演示方便设置为return ERROR;
随后访问http://localhost:8088/S2_001_war_exploded/login.action?"><script>alert(1)</script><"      
![avatar](/pictures/02rec.png)      
xss是怎么产生的呢？我们来看看源代码，可以看到源代码中，在最开始index.jsp的源代码中显示了跳转页面的url。   
![avatar](/pictures/view-source01.png)   
而在在后面的页面中闭合了刚刚的链接，而<script>标签则暴露在标签外，由此执行了xss。     
![avatar](/pictures/view-source02.png)   

#### S2-006
还是刚刚S2-002的漏洞环境，只是将struts.xml中的验证如果错误返回的页面去掉，此时就会触发S2-006的漏洞。
### 漏洞分析（S2-002）
#### 影响版本
Struts 2.0.0 - Struts 2.1.8.1
#### 漏洞成因
在S2中对于<s:url>和<s:a>标签，当构造和呈现标记的结果显示为url时，可以注入没有正确转义的参数值。已知下列情况:     
<s: a>构造中包含的参数值:结果可以注入一个未转义的双引号，这样就可以通过转义呈现的href属性在生成的HTML中注入代码。      
<s:url>和<s:a>标签无法转义当includeParams被设置为“none”以外的任何值时，可以通过调用包含JSP/操作的GET参数来利用标记，例如http://localhost/foo/bar.action?<script>alert(1)</script>test=hello   

### 漏洞分析（S2-006）
#### 影响版本
Struts 2.0.0 - Struts 2.2.1.1
#### 漏洞成因
默认情况下，XWork不会在自动生成的错误页面中转义动作的名称，从而可以成功进行XSS攻击。启用动态方法调用（DMI）时，将基于请求参数动态生成操作名称。这允许调用不存在的页面和方法来生成带有注入代码的错误页面。
#### 漏洞修复
1. 在struts.xml中禁用DMI支持
```
<constant name="struts.enable.DynamicMethodInvocation" value="false" />
```
2. 在struts.xml中定义错误页面
```
<result name="error">/error_page.jsp</result>
```

#### 总结
虽然xss比较简单，但是如果从一个挖洞的人员的思路来说还是挺难的。在这个框架里需要了解链接标签的机制，复现环境中的环境比较简单，但真实环境中还需要找到可利用的点，或者需要去构造特殊的payload。总的来说还是需要积累。

### 参考链接
https://www.cnblogs.com/pingxin/p/p00024.html       
https://dean2021.github.io/posts/s2-002/    
https://cwiki.apache.org/confluence/display/WW/S2-002
